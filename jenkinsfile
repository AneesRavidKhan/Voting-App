pipeline {

agent any

stages {

    stage ('Unit-Test') {
        steps {
            sh 'mvn test'
        }
    }

    stage ('Publish-Test-Reports') {
        steps {
            junit 'target/surefire-reports/*.xml'
        }
    }

    stage ('Build') {
        steps {
            sh 'mvn package -DskipTests'
        }
    }

    stage ('BuiArchive-Artifactsld') {
        steps {
            archiveArtifacts artifacts: 'target/*.war'
        }
    }

    stage ('Build-DockerImage') {
        agent { label 'ec2-mac' }
        steps {
            sh '''
            whoami
            scp -i /home/Khan/key.pem Dockerfile ubuntu@65.2.182.84:/home/ubuntu/
            scp -i /home/Khan/key.pem target/hello-world.war ubuntu@65.2.182.84:/home/ubuntu/
            sudo docker build -t java-app:$BUILD_NUMBER
            '''
        }
    }

    stage ('Deploy') {
        steps {
            sh 'scp -i /home/Khan/key.pem target/hello-world.war ubuntu@3.108.218.192:/home/ubuntu/'
        }
    }

}

}